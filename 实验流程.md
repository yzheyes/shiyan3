# RDT协议实验详细流程

## 实验概述

本实验通过模拟器研究不同RDT协议的性能特征，完成6项实验作业，收集足够的数据用于撰写实验报告。

**实验协议：** 协议5（回退N帧）、协议6（选择性重传）

---

## 实验一：协议性能研究

### 1.1 实验目标
研究协议性能（效率）作为校验和错误率、丢包率和超时间隔的函数。

### 1.2 实验参数设计

#### 1.2.1 超时间隔对性能的影响
**固定参数：** 协议5, events=50000, 丢包率=10%, 校验和错误率=5%, debug=0

| 实验编号 | 超时间隔 | 命令 |
|----------|----------|------|
| 1 | 20 | `./sim 5 50000 20 10 5 0` |
| 2 | 30 | `./sim 5 50000 30 10 5 0` |
| 3 | 40 | `./sim 5 50000 40 10 5 0` |
| 4 | 50 | `./sim 5 50000 50 10 5 0` |
| 5 | 60 | `./sim 5 50000 60 10 5 0` |
| 6 | 80 | `./sim 5 50000 80 10 5 0` |
| 7 | 100 | `./sim 5 50000 100 10 5 0` |
| 8 | 120 | `./sim 5 50000 120 10 5 0` |
| 9 | 150 | `./sim 5 50000 150 10 5 0` |

#### 1.2.2 丢包率对性能的影响
**固定参数：** 协议5, events=50000, 超时间隔=50, 校验和错误率=5%, debug=0

| 实验编号 | 丢包率 | 命令 |
|----------|--------|------|
| 1 | 0% | `./sim 5 50000 50 0 5 0` |
| 2 | 5% | `./sim 5 50000 50 5 5 0` |
| 3 | 10% | `./sim 5 50000 50 10 5 0` |
| 4 | 15% | `./sim 5 50000 50 15 5 0` |
| 5 | 20% | `./sim 5 50000 50 20 5 0` |
| 6 | 25% | `./sim 5 50000 50 25 5 0` |
| 7 | 30% | `./sim 5 50000 50 30 5 0` |

#### 1.2.3 校验和错误率对性能的影响
**固定参数：** 协议5, events=50000, 超时间隔=50, 丢包率=10%, debug=0

| 实验编号 | 校验和错误率 | 命令 |
|----------|--------------|------|
| 1 | 0% | `./sim 5 50000 50 10 0 0` |
| 2 | 5% | `./sim 5 50000 50 10 5 0` |
| 3 | 10% | `./sim 5 50000 50 10 10 0` |
| 4 | 15% | `./sim 5 50000 50 10 15 0` |
| 5 | 20% | `./sim 5 50000 50 10 20 0` |
| 6 | 25% | `./sim 5 50000 50 10 25 0` |

### 1.3 数据收集表格

#### 表1.1：超时间隔实验数据记录表

| 超时间隔 | 效率(%) | 发送帧数 | 接受载荷数 | 重传帧数 | 超时次数 | 丢包数 | 坏帧数 |
|----------|---------|----------|------------|----------|----------|--------|--------|
| 20 | | | | | | | |
| 30 | | | | | | | |
| 40 | | | | | | | |
| 50 | | | | | | | |
| 60 | | | | | | | |
| 80 | | | | | | | |
| 100 | | | | | | | |
| 120 | | | | | | | |
| 150 | | | | | | | |

#### 表1.2：丢包率实验数据记录表

| 丢包率 | 效率(%) | 发送帧数 | 接受载荷数 | 重传帧数 | 超时次数 | 丢包数 | 坏帧数 |
|--------|---------|----------|------------|----------|----------|--------|--------|
| 0% | | | | | | | |
| 5% | | | | | | | |
| 10% | | | | | | | |
| 15% | | | | | | | |
| 20% | | | | | | | |
| 25% | | | | | | | |
| 30% | | | | | | | |

#### 表1.3：校验和错误率实验数据记录表

| 校验和错误率 | 效率(%) | 发送帧数 | 接受载荷数 | 重传帧数 | 超时次数 | 丢包数 | 坏帧数 |
|--------------|---------|----------|------------|----------|----------|--------|--------|
| 0% | | | | | | | |
| 5% | | | | | | | |
| 10% | | | | | | | |
| 15% | | | | | | | |
| 20% | | | | | | | |
| 25% | | | | | | | |

### 1.4 批量执行脚本

创建脚本文件 `run_exp1.sh`：

```bash
#!/bin/bash
# 实验一：协议性能研究

echo "=== 实验一：协议性能研究 ==="
echo "开始时间: $(date)"

# 创建输出目录
mkdir -p exp1_results

# 实验组A：超时间隔
echo ""
echo "=== 实验组A：超时间隔对性能的影响 ==="
for timeout in 20 30 40 50 60 80 100 120 150; do
    echo "运行实验: 超时间隔=$timeout"
    ./sim 5 50000 $timeout 10 5 0 > exp1_results/A_timeout_${timeout}.txt 2>&1
    sleep 1
done

# 实验组B：丢包率
echo ""
echo "=== 实验组B：丢包率对性能的影响 ==="
for loss in 0 5 10 15 20 25 30; do
    echo "运行实验: 丢包率=$loss%"
    ./sim 5 50000 50 $loss 5 0 > exp1_results/B_loss_${loss}.txt 2>&1
    sleep 1
done

# 实验组C：校验和错误率
echo ""
echo "=== 实验组C：校验和错误率对性能的影响 ==="
for cksum in 0 5 10 15 20 25; do
    echo "运行实验: 校验和错误率=$cksum%"
    ./sim 5 50000 50 10 $cksum 0 > exp1_results/C_cksum_${cksum}.txt 2>&1
    sleep 1
done

echo ""
echo "实验一完成！结束时间: $(date)"
```

### 1.5 数据提取脚本

创建脚本文件 `extract_exp1.sh`：

```bash
#!/bin/bash
# 提取实验一数据

echo "=== 提取实验一数据 ==="

# 提取效率
echo "效率数据:"
echo "超时间隔实验:"
for timeout in 20 30 40 50 60 80 100 120 150; do
    eff=$(grep "Efficiency" exp1_results/A_timeout_${timeout}.txt | grep -oP '\d+(?=%)')
    echo "  超时间隔=$timeout: 效率=$eff%"
done

echo ""
echo "丢包率实验:"
for loss in 0 5 10 15 20 25 30; do
    eff=$(grep "Efficiency" exp1_results/B_loss_${loss}.txt | grep -oP '\d+(?=%)')
    echo "  丢包率=$loss%: 效率=$eff%"
done

echo ""
echo "校验和错误率实验:"
for cksum in 0 5 10 15 20 25; do
    eff=$(grep "Efficiency" exp1_results/C_cksum_${cksum}.txt | grep -oP '\d+(?=%)')
    echo "  校验和错误率=$cksum%: 效率=$eff%"
done
```

---

## 实验二：协议5与协议6性能对比

### 2.1 实验目标
详细比较协议5和协议6在各种参数下的性能。

### 2.2 实验参数设计

#### 2.2.1 不同丢包率下的对比
**固定参数：** events=50000, 超时间隔=50, 校验和错误率=5%, debug=0

| 丢包率 | 协议5命令 | 协议6命令 |
|--------|-----------|-----------|
| 0% | `./sim 5 50000 50 0 5 0` | `./sim 6 50000 50 0 5 0` |
| 5% | `./sim 5 50000 50 5 5 0` | `./sim 6 50000 50 5 5 0` |
| 10% | `./sim 5 50000 50 10 5 0` | `./sim 6 50000 50 10 5 0` |
| 15% | `./sim 5 50000 50 15 5 0` | `./sim 6 50000 50 15 5 0` |
| 20% | `./sim 5 50000 50 20 5 0` | `./sim 6 50000 50 20 5 0` |
| 25% | `./sim 5 50000 50 25 5 0` | `./sim 6 50000 50 25 5 0` |
| 30% | `./sim 5 50000 50 30 5 0` | `./sim 6 50000 50 30 5 0` |

#### 2.2.2 不同超时间隔下的对比
**固定参数：** events=50000, 丢包率=10%, 校验和错误率=5%, debug=0

| 超时间隔 | 协议5命令 | 协议6命令 |
|----------|-----------|-----------|
| 20 | `./sim 5 50000 20 10 5 0` | `./sim 6 50000 20 10 5 0` |
| 30 | `./sim 5 50000 30 10 5 0` | `./sim 6 50000 30 10 5 0` |
| 40 | `./sim 5 50000 40 10 5 0` | `./sim 6 50000 40 10 5 0` |
| 50 | `./sim 5 50000 50 10 5 0` | `./sim 6 50000 50 10 5 0` |
| 60 | `./sim 5 50000 60 10 5 0` | `./sim 6 50000 60 10 5 0` |
| 80 | `./sim 5 50000 80 10 5 0` | `./sim 6 50000 80 10 5 0` |
| 100 | `./sim 5 50000 100 10 5 0` | `./sim 6 50000 100 10 5 0` |

#### 2.2.3 不同校验和错误率下的对比
**固定参数：** events=50000, 超时间隔=50, 丢包率=10%, debug=0

| 校验和错误率 | 协议5命令 | 协议6命令 |
|--------------|-----------|-----------|
| 0% | `./sim 5 50000 50 10 0 0` | `./sim 6 50000 50 10 0 0` |
| 5% | `./sim 5 50000 50 10 5 0` | `./sim 6 50000 50 10 5 0` |
| 10% | `./sim 5 50000 50 10 10 0` | `./sim 6 50000 50 10 10 0` |
| 15% | `./sim 5 50000 50 10 15 0` | `./sim 6 50000 50 10 15 0` |
| 20% | `./sim 5 50000 50 10 20 0` | `./sim 6 50000 50 10 20 0` |
| 25% | `./sim 5 50000 50 10 25 0` | `./sim 6 50000 50 10 25 0` |

### 2.3 数据收集表格

#### 表2.1：丢包率对比数据表

| 丢包率 | P5效率(%) | P6效率(%) | P5重传 | P6重传 | P5超时 | P6超时 | P5发送 | P6发送 |
|--------|-----------|-----------|--------|--------|--------|--------|--------|--------|
| 0% | | | | | | | | |
| 5% | | | | | | | | |
| 10% | | | | | | | | |
| 15% | | | | | | | | |
| 20% | | | | | | | | |
| 25% | | | | | | | | |
| 30% | | | | | | | | |

#### 表2.2：超时间隔对比数据表

| 超时间隔 | P5效率(%) | P6效率(%) | P5重传 | P6重传 | P5超时 | P6超时 | P5发送 | P6发送 |
|----------|-----------|-----------|--------|--------|--------|--------|--------|--------|
| 20 | | | | | | | | |
| 30 | | | | | | | | |
| 40 | | | | | | | | |
| 50 | | | | | | | | |
| 60 | | | | | | | | |
| 80 | | | | | | | | |
| 100 | | | | | | | | |

#### 表2.3：校验和错误率对比数据表

| 校验和错误率 | P5效率(%) | P6效率(%) | P5重传 | P6重传 | P5超时 | P6超时 | P5发送 | P6发送 |
|--------------|-----------|-----------|--------|--------|--------|--------|--------|--------|
| 0% | | | | | | | | |
| 5% | | | | | | | | |
| 10% | | | | | | | | |
| 15% | | | | | | | | |
| 20% | | | | | | | | |
| 25% | | | | | | | | |

### 2.4 批量执行脚本

创建脚本文件 `run_exp2.sh`：

```bash
#!/bin/bash
# 实验二：协议5与协议6性能对比

echo "=== 实验二：协议5与协议6性能对比 ==="
echo "开始时间: $(date)"

mkdir -p exp2_results

# 实验组D：不同丢包率
echo ""
echo "=== 实验组D：不同丢包率下的对比 ==="
for loss in 0 5 10 15 20 25 30; do
    echo "运行实验: 丢包率=$loss%"
    ./sim 5 50000 50 $loss 5 0 > exp2_results/D_loss_${loss}_p5.txt 2>&1
    ./sim 6 50000 50 $loss 5 0 > exp2_results/D_loss_${loss}_p6.txt 2>&1
    sleep 1
done

# 实验组E：不同超时间隔
echo ""
echo "=== 实验组E：不同超时间隔下的对比 ==="
for timeout in 20 30 40 50 60 80 100; do
    echo "运行实验: 超时间隔=$timeout"
    ./sim 5 50000 $timeout 10 5 0 > exp2_results/E_timeout_${timeout}_p5.txt 2>&1
    ./sim 6 50000 $timeout 10 5 0 > exp2_results/E_timeout_${timeout}_p6.txt 2>&1
    sleep 1
done

# 实验组F：不同校验和错误率
echo ""
echo "=== 实验组F：不同校验和错误率下的对比 ==="
for cksum in 0 5 10 15 20 25; do
    echo "运行实验: 校验和错误率=$cksum%"
    ./sim 5 50000 50 10 $cksum 0 > exp2_results/F_cksum_${cksum}_p5.txt 2>&1
    ./sim 6 50000 50 10 $cksum 0 > exp2_results/F_cksum_${cksum}_p6.txt 2>&1
    sleep 1
done

echo ""
echo "实验二完成！结束时间: $(date)"
```

### 2.5 数据提取脚本

创建脚本文件 `extract_exp2.sh`：

```bash
#!/bin/bash
# 提取实验二数据

echo "=== 实验二：协议5与协议6对比数据 ==="

echo ""
echo "丢包率对比:"
printf "%-8s %-10s %-10s %-8s %-8s %-8s %-8s %-8s %-8s\n" \
    "丢包率" "P5效率" "P6效率" "P5重传" "P6重传" "P5超时" "P6超时" "P5发送" "P6发送"

for loss in 0 5 10 15 20 25 30; do
    p5_eff=$(grep "Efficiency" exp2_results/D_loss_${loss}_p5.txt | grep -oP '\d+(?=%)')
    p6_eff=$(grep "Efficiency" exp2_results/D_loss_${loss}_p6.txt | grep -oP '\d+(?=%)')
    p5_ret=$(grep "retransmitted" exp2_results/D_loss_${loss}_p5.txt | awk '{print $NF}')
    p6_ret=$(grep "retransmitted" exp2_results/D_loss_${loss}_p6.txt | awk '{print $NF}')
    p5_to=$(grep "Timeouts:" exp2_results/D_loss_${loss}_p5.txt | awk '{print $NF}')
    p6_to=$(grep "Timeouts:" exp2_results/D_loss_${loss}_p6.txt | awk '{print $NF}')
    p5_sent=$(grep "Total data frames sent" exp2_results/D_loss_${loss}_p5.txt | awk '{print $NF}')
    p6_sent=$(grep "Total data frames sent" exp2_results/D_loss_${loss}_p6.txt | awk '{print $NF}')
    printf "%-8s %-10s %-10s %-8s %-8s %-8s %-8s %-8s %-8s\n" \
        "${loss}%" "$p5_eff%" "$p6_eff%" "$p5_ret" "$p6_ret" "$p5_to" "$p6_to" "$p5_sent" "$p6_sent"
done
```

---

## 实验三：事件优先级研究

### 3.1 实验目标
研究pick_event()中事件优先级对协议性能的影响。

### 3.2 实验步骤

#### 步骤1：备份原始文件
```bash
cp worker.c worker.c.backup
```

#### 步骤2：查看原始优先级
在`worker.c`第219-223行，协议5的原始事件优先级：

```c
case 5:
    if (nframes > 0) return((int)frametype());           // 优先级1：帧到达
    if (network_layer_status) return(network_layer_ready); // 优先级2：网络层就绪
    if (check_timers() >= 0) return(timeout);            // 优先级3：超时
    return(NO_EVENT);
```

#### 步骤3：修改优先级方案

**方案A：超时优先**
修改`worker.c`第219-223行为：
```c
case 5:
    if (check_timers() >= 0) return(timeout);            // 优先级1：超时
    if (nframes > 0) return((int)frametype());           // 优先级2：帧到达
    if (network_layer_status) return(network_layer_ready); // 优先级3：网络层就绪
    return(NO_EVENT);
```

**方案B：网络层就绪优先**
修改`worker.c`第219-223行为：
```c
case 5:
    if (network_layer_status) return(network_layer_ready); // 优先级1：网络层就绪
    if (nframes > 0) return((int)frametype());           // 优先级2：帧到达
    if (check_timers() >= 0) return(timeout);            // 优先级3：超时
    return(NO_EVENT);
```

#### 步骤4：重新编译和测试

```bash
# 每次修改后重新编译
make clean
make

# 测试每种优先级方案
./sim 5 50000 50 10 5 0 > priority_original.txt
./sim 5 50000 50 10 5 0 > priority_timeout_first.txt
./sim 5 50000 50 10 5 0 > priority_net_first.txt
```

### 3.3 数据收集表格

#### 表3.1：事件优先级对比数据表

| 优先级方案 | 效率(%) | 重传帧数 | 超时次数 | 发送帧数 | 接受载荷数 |
|------------|---------|----------|----------|----------|------------|
| 原始（帧到达优先） | | | | | |
| 超时优先 | | | | | |
| 网络层就绪优先 | | | | | |

### 3.4 批量执行脚本

创建脚本文件 `run_exp3.sh`：

```bash
#!/bin/bash
# 实验三：事件优先级研究

echo "=== 实验三：事件优先级研究 ==="
echo "开始时间: $(date)"

mkdir -p exp3_results

# 测试参数
TEST_PARAMS="5 50000 50 10 5 0"

echo ""
echo "=== 测试1：原始优先级（帧到达优先）==="
cp worker.c.backup worker.c
make clean && make
./sim $TEST_PARAMS > exp3_results/original.txt 2>&1

echo ""
echo "=== 测试2：超时优先 ==="
# 修改worker.c，将超时检查放在最前面
sed -i '219,223s/if (nframes > 0) return((int)frametype());/\/\/ 超时优先\n    if (check_timers() >= 0) return(timeout);/' worker.c
sed -i '220,224s/if (network_layer_status) return(network_layer_ready);/if (nframes > 0) return((int)frametype());\n    if (network_layer_status) return(network_layer_ready);/' worker.c
make clean && make
./sim $TEST_PARAMS > exp3_results/timeout_first.txt 2>&1

echo ""
echo "=== 测试3：网络层就绪优先 ==="
cp worker.c.backup worker.c
# 修改worker.c，将网络层就绪检查放在最前面
sed -i '219,223s/if (nframes > 0) return((int)frametype());/\/\/ 网络层就绪优先\n    if (network_layer_status) return(network_layer_ready);/' worker.c
sed -i '220,224s/if (network_layer_status) return(network_layer_ready);/if (nframes > 0) return((int)frametype());\n    if (check_timers() >= 0) return(timeout);/' worker.c
make clean && make
./sim $TEST_PARAMS > exp3_results/net_first.txt 2>&1

# 恢复原始文件
cp worker.c.backup worker.c
make clean && make

echo ""
echo "实验三完成！结束时间: $(date)"
```

---

## 实验四：重传帧数量研究

### 4.1 实验目标
调查重传帧数量作为超时间隔的函数，确定最佳超时间隔设置。

### 4.2 实验参数设计

#### 4.2.1 协议5重传研究
| 超时间隔 | 丢包率0% | 丢包率5% | 丢包率10% | 丢包率15% | 丢包率20% | 丢包率25% |
|----------|---------|---------|-----------|-----------|-----------|-----------|
| 20 | | | | | | |
| 30 | | | | | | |
| 40 | | | | | | |
| 50 | | | | | | |
| 60 | | | | | | |
| 80 | | | | | | |
| 100 | | | | | | |
| 120 | | | | | | |
| 150 | | | | | | |

#### 4.2.2 协议6重传研究
| 超时间隔 | 丢包率0% | 丢包率5% | 丢包率10% | 丢包率15% | 丢包率20% | 丢包率25% |
|----------|---------|---------|-----------|-----------|-----------|-----------|
| 20 | | | | | | |
| 30 | | | | | | |
| 40 | | | | | | |
| 50 | | | | | | |
| 60 | | | | | | |
| 80 | | | | | | |
| 100 | | | | | | |
| 120 | | | | | | |
| 150 | | | | | | |

### 4.3 批量执行脚本

创建脚本文件 `run_exp4.sh`：

```bash
#!/bin/bash
# 实验四：重传帧数量研究

echo "=== 实验四：重传帧数量研究 ==="
echo "开始时间: $(date)"

mkdir -p exp4_results

# 协议5重传研究
echo ""
echo "=== 实验组G：协议5重传研究 ==="
for timeout in 20 30 40 50 60 80 100 120 150; do
    for loss in 0 5 10 15 20 25; do
        echo "运行: P5, 超时=$timeout, 丢包=$loss%"
        ./sim 5 50000 $timeout $loss 5 0 > exp4_results/P5_t${timeout}_l${loss}.txt 2>&1
        sleep 0.5
    done
done

# 协议6重传研究
echo ""
echo "=== 实验组H：协议6重传研究 ==="
for timeout in 20 30 40 50 60 80 100 120 150; do
    for loss in 0 5 10 15 20 25; do
        echo "运行: P6, 超时=$timeout, 丢包=$loss%"
        ./sim 6 50000 $timeout $loss 5 0 > exp4_results/P6_t${timeout}_l${loss}.txt 2>&1
        sleep 0.5
    done
done

echo ""
echo "实验四完成！结束时间: $(date)"
```

### 4.4 数据提取脚本

创建脚本文件 `extract_exp4.sh`：

```bash
#!/bin/bash
# 提取实验四数据

echo "=== 实验四：重传帧数量研究 ==="

echo ""
echo "协议5重传数据:"
printf "%-10s %-8s %-8s %-8s %-8s %-8s %-8s\n" \
    "超时间隔" "丢包0%" "丢包5%" "丢包10%" "丢包15%" "丢包20%" "丢包25%"

for timeout in 20 30 40 50 60 80 100 120 150; do
    printf "%-10s" $timeout
    for loss in 0 5 10 15 20 25; do
        ret=$(grep "retransmitted" exp4_results/P5_t${timeout}_l${loss}.txt | awk '{print $NF}')
        printf "%-8s" "$ret"
    done
    printf "\n"
done

echo ""
echo "协议6重传数据:"
printf "%-10s %-8s %-8s %-8s %-8s %-8s %-8s\n" \
    "超时间隔" "丢包0%" "丢包5%" "丢包10%" "丢包15%" "丢包20%" "丢包25%"

for timeout in 20 30 40 50 60 80 100 120 150; do
    printf "%-10s" $timeout
    for loss in 0 5 10 15 20 25; do
        ret=$(grep "retransmitted" exp4_results/P6_t${timeout}_l${loss}.txt | awk '{print $NF}')
        printf "%-8s" "$ret"
    done
    printf "\n"
done
```

---

## 实验五：模拟器时间推进优化

### 5.1 实验目标
优化模拟器时间推进机制，在两个进程都在等待超时时更快地推进时间。

### 5.2 实验步骤

#### 步骤1：分析当前机制
查看`sim.c`第74-89行，当前每次只前进DELTA（10）个tick。

#### 步骤2：优化实现

在`sim.c`中修改主循环，添加快速时间推进逻辑：

```c
// 在主循环中添加
while (tick < last_tick) {
    process = rand() & 1;

    // 检查两个进程是否都在等待超时
    if (hanging[0] >= DELTA && hanging[1] >= DELTA) {
        // 两个进程都在等待，跳过多个时间单位
        tick = tick + DELTA * 10;
        rfd = (process == 0 ? r4 : r6);
        if (read(rfd, &word, TICK_SIZE) != TICK_SIZE) terminate("");
        if (word == OK) hanging[process] = 0;
        if (word == NOTHING) hanging[process] += DELTA * 10;
    } else {
        tick = tick + DELTA;
        rfd = (process == 0 ? r4 : r6);
        if (read(rfd, &word, TICK_SIZE) != TICK_SIZE) terminate("");
        if (word == OK) hanging[process] = 0;
        if (word == NOTHING) hanging[process] += DELTA;
    }
    ...
}
```

#### 步骤3：性能测试

```bash
# 备份原始sim.c
cp sim.c sim.c.backup

# 测试原始版本性能
echo "测试原始版本..."
time ./sim 5 100000 100 10 5 0 > original_perf.txt 2>&1

# 修改并测试优化版本
# （修改sim.c后）
make clean && make
echo "测试优化版本..."
time ./sim 5 100000 100 10 5 0 > optimized_perf.txt 2>&1

# 恢复原始版本
cp sim.c.backup sim.c
make clean && make
```

### 5.3 数据收集表格

#### 表5.1：性能对比数据表

| 版本 | 运行时间(秒) | 效率(%) | 超时次数 | 重传帧数 |
|------|-------------|---------|----------|----------|
| 原始版本 | | | | |
| 优化版本 | | | | |

---

## 实验六：可变数据包传递时间

### 6.1 实验目标
实现可变的数据包传递时间，研究延迟方差对协议性能的影响。

### 6.2 实验步骤

#### 步骤1：修改数据结构
在`common.h`中添加：
```c
extern int base_delay;      // 基础延迟
extern int delay_variance;   // 延迟方差
```

#### 步骤2：修改参数解析
在`sim.c`的`parse_args()`函数中添加延迟参数解析。

#### 步骤3：实现延迟队列
在`worker.c`中添加延迟传递机制（详见实验指南）。

#### 步骤4：编译测试

```bash
make clean && make

# 测试不同延迟方差
for var in 0 5 10 20 30; do
    echo "测试延迟方差=$var"
    ./sim 5 50000 50 10 5 0 10 $var > delay_var_${var}.txt 2>&1
done
```

### 6.3 数据收集表格

#### 表6.1：延迟方差影响数据表

| 延迟方差 | 效率(%) | 超时次数 | 重传帧数 | 发送帧数 | 接受载荷数 |
|----------|---------|----------|----------|----------|------------|
| 0 | | | | | |
| 5 | | | | | |
| 10 | | | | | |
| 20 | | | | | |
| 30 | | | | | |

---

## 实验执行顺序

### 第一阶段：基础实验（1-2天）
1. 编译模拟器，熟悉基本使用
2. 执行实验一（协议性能研究）
3. 执行实验二（协议5与协议6对比）

### 第二阶段：代码修改实验（2-3天）
4. 执行实验三（事件优先级研究）
5. 执行实验四（重传帧数量研究）

### 第三阶段：高级实验（2-3天）
6. 执行实验五（时间推进优化）
7. 执行实验六（可变延迟）

### 第四阶段：数据整理与分析（2-3天）
8. 提取所有实验数据
9. 绘制图表
10. 撰写实验报告

---

## 数据整理模板

创建数据整理Excel/CSV模板文件 `data_template.csv`：

```csv
实验组,协议,超时间隔,丢包率,校验和错误率,效率,重传帧数,超时次数,发送帧数,接受载荷数,备注
实验1-超时间隔,P5,20,10,5,,,,,,
实验1-超时间隔,P5,30,10,5,,,,,,
实验1-超时间隔,P5,40,10,5,,,,,,
...
实验1-丢包率,P5,50,0,5,,,,,,
实验1-丢包率,P5,50,5,5,,,,,,
...
实验2-丢包率对比,P5,50,0,5,,,,,,
实验2-丢包率对比,P6,50,0,5,,,,,,
...
```

---

## 实验注意事项

1. **数据备份**：每次实验后及时备份数据
2. **版本控制**：修改代码前先备份原始文件
3. **记录日志**：记录每次实验的参数和结果
4. **多次运行**：关键实验建议多次运行取平均值
5. **环境一致**：保持实验环境的一致性

---

## 实验报告所需数据清单

### 必需数据
- [ ] 效率数据（所有实验组）
- [ ] 重传帧数（所有实验组）
- [ ] 超时次数（所有实验组）
- [ ] 发送帧数（所有实验组）
- [ ] 接受载荷数（所有实验组）

### 可选数据
- [ ] 丢包数
- [ ] 坏帧数
- [ ] ACK发送数
- [ ] ACK接收数

### 图表数据
- [ ] 效率 vs 超时间隔（协议5）
- [ ] 效率 vs 丢包率（协议5）
- [ ] 效率 vs 校验和错误率（协议5）
- [ ] 协议5 vs 协议6效率对比
- [ ] 协议5 vs 协议6重传对比
- [ ] 重传次数 vs 超时间隔
- [ ] 事件优先级对比
- [ ] 延迟方差影响

---

## 快速开始指南

```bash
# 1. 进入模拟器目录
cd rdt/simulator_new

# 2. 编译模拟器
make clean && make

# 3. 运行简单测试
./sim 5 10000 50 10 5 3

# 4. 运行实验一
chmod +x run_exp1.sh
./run_exp1.sh

# 5. 提取数据
chmod +x extract_exp1.sh
./extract_exp1.sh
```
